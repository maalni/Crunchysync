var createdtab=void 0,animes=[],unavailable=[],available=[],userIsPremium=!1;function checkUnavailableAnimes(){chrome.storage.local.get(["unavailable","userIsPremium"],function(e){void 0!==e.userIsPremium&&(userIsPremium="true"===e.userIsPremium),chrome.cookies.get({url:"http://crunchyroll.com",name:"sess_id"},function(s){if(null!=s){console.log(s);var l="https://api.crunchyroll.com/queue.0.json?&fields=most_likely_media,series,series.name,series.media_count,series.series_id,media.description,media.media_id,media.free_available_time,media.name,media.url,media.episode_number,series.url,media.screenshot_image,media.duration,media.playhead,media.premium_only,image.fwide_url&media_types=anime|drama&locale=enUS&session_id="+s.value,n=new XMLHttpRequest;n.onreadystatechange=function(){if(4==n.readyState&&200==n.status)if(JSON.parse(n.responseText).error)chrome.notifications.create({type:"basic",iconUrl:"assets/icons/crunchysync.png",title:"Crunchysync encountered an error",message:JSON.parse(n.responseText).code});else{if(void 0!==e.unavailable||e.unavailable!=={}){for(a in unavailable=e.unavailable,(animes=JSON.parse(n.responseText).data).sort((e,a)=>e.series.name.localeCompare(a.series.name)),chrome.storage.local.set({animes:animes}),unavailable){var s=unavailable[a];for(b in animes){if(void 0!==(l=animes[b]).most_likely_media&&l.series.series_id===s.series.series_id){if(l.most_likely_media.media_id!==s.most_likely_media.media_id){l.most_likely_media.episode_number>s.most_likely_media.episode_number&&(l.most_likely_media.premium_only?userIsPremium&&available.push(l):available.push(l)),animes.splice(b,1);break}l.most_likely_media.playhead>=s.most_likely_media.duration-10||!l.most_likely_media.premium_only&&s.most_likely_media.premium_only&&(userIsPremium||available.push(l))}}}for(i in available){var l=available[i];chrome.notifications.create(l.most_likely_media.url,{type:"image",iconUrl:"assets/icons/crunchysync.png",imageUrl:l.most_likely_media.screenshot_image.fwide_url,title:"A new Episode of "+l.series.name+" is available",message:l.most_likely_media.name+"\nEpisode Nr."+l.most_likely_media.episode_number})}chrome.notifications.onClicked.addListener(function(e){chrome.tabs.create({url:e})})}animes=animes.filter(e=>void 0!==e.most_likely_media),unavailable=animes.filter(e=>e.most_likely_media.playhead>=e.most_likely_media.duration-10&&0!=e.most_likely_media.duration),userIsPremium||(unavailable=unavailable.concat(animes.filter(e=>e.most_likely_media.premium_only))),chrome.storage.local.set({unavailable:unavailable})}},n.open("GET",l,!0),n.send(null)}})})}chrome.runtime.onStartup.addListener(function(){chrome.alarms.create("checkUnavailableAnimes",{delayInMinutes:30}),chrome.storage.local.get(["disableBackgroundChecks","firstuse"],function(e){void 0!==e.disableBackgroundChecks&&"false"===e.disableBackgroundChecks&&void 0!==e.firstuse&&"false"===e.firstuse&&chrome.cookies.get({url:"http://crunchyroll.com",name:"sess_id"},function(e){console.log(e),null==e||void 0==e||""==e.value?chrome.tabs.create({url:"index.html"},function(e){createdtab=e}):checkUnavailableAnimes()})})}),chrome.runtime.onInstalled.addListener(function(e){chrome.alarms.create("checkUnavailableAnimes",{delayInMinutes:30}),chrome.storage.local.get(["disableBackgroundChecks","firstuse"],function(e){void 0!==e.disableBackgroundChecks&&"false"===e.disableBackgroundChecks&&void 0!==e.firstuse&&"false"===e.firstuse&&chrome.cookies.get({url:"http://crunchyroll.com",name:"sess_id"},function(e){console.log(e),null==e||void 0==e||""==e.value?chrome.tabs.create({url:"index.html"},function(e){createdtab=e}):checkUnavailableAnimes()})})}),chrome.alarms.onAlarm.addListener(function(e){chrome.storage.local.get(["disableBackgroundChecks","firstuse"],function(a){void 0!==a.disableBackgroundChecks&&"false"===a.disableBackgroundChecks&&void 0!==a.firstuse&&"false"===a.firstuse&&"checkUnavailableAnimes"===e.name&&checkUnavailableAnimes()})}),chrome.runtime.onMessage.addListener(function(e,a,i){"onAuthenticatedEvent"==e.data&&chrome.tabs.query({url:"chrome-extension://*/index.html"},function(e){if(void 0!==createdtab)for(var a in checkUnavailableAnimes(),e){if(e[a].id===createdtab.id){chrome.tabs.remove(createdtab.id),createdtab=void 0;break}}})});