var createdtab=undefined;var animes=[];var unavailable=[];var available=[];chrome.runtime.onStartup.addListener(function(){chrome.storage.local.get(["disableBackgroundChecks","firstuse"],function(result){if((result.disableBackgroundChecks!==undefined&&result.disableBackgroundChecks==="false")&&(result.firstuse!==undefined&&result.firstuse==="false")){chrome.tabs.create({url:"index.html"},function(tab){createdtab=tab})}})});chrome.runtime.onInstalled.addListener(function(details){chrome.storage.local.get(["disableBackgroundChecks","firstuse"],function(result){if((result.disableBackgroundChecks!==undefined&&result.disableBackgroundChecks==="false")&&(result.firstuse!==undefined&&result.firstuse==="false")){chrome.tabs.create({url:"index.html"},function(tab){createdtab=tab})}})});chrome.alarms.onAlarm.addListener(function(alarm){if(alarm.name==="checkUnavailableAnimes"){checkUnavailableAnimes()}});chrome.runtime.onMessage.addListener(function(request,sender,sendResponse){if(request.data=="onAuthenticatedEvent"){chrome.tabs.query({url:"chrome-extension://*/index.html"},function(result){if(createdtab!==undefined){checkUnavailableAnimes();for(var i in result){var tab=result[i];if(tab.id===createdtab.id){chrome.tabs.remove(createdtab.id);createdtab=undefined;break}}}})}
if(request.data=="getSessionId"){chrome.cookies.get({"url":"http://crunchyroll.com","name":"sess_id"},function(cookie){sendResponse({sessionid:cookie})});return!0}
if(request.data=="injectContentScriptCss"){chrome.tabs.query({url:"*://*.crunchyroll.com/home/queue*"},function(result){chrome.tabs.insertCSS(result[0].id,{file:"queuescript.min.css"})})}});function checkUnavailableAnimes(){chrome.storage.local.get(["unavailable"],function(result){chrome.cookies.get({"url":"http://crunchyroll.com","name":"sess_id"},function(cookie){if(cookie!=null){var apiurl="https://api.crunchyroll.com/queue.0.json?"+"&fields=most_likely_media,series,series.name,series.media_count,series.series_id,media.description,media.media_id,media.free_available_time,media.name,media.url,media.episode_number,series.url,media.screenshot_image,media.duration,media.playhead,media.premium_only,image.fwide_url"+"&media_types=anime|drama"+"&locale=enUS"+"&session_id="+cookie.value;var xmlHttp=new XMLHttpRequest();xmlHttp.onreadystatechange=function(){if(xmlHttp.readyState==4&&xmlHttp.status==200){if(!JSON.parse(xmlHttp.responseText).error){chrome.alarms.create("checkUnavailableAnimes",{delayInMinutes:30});if(result.unavailable!==undefined||result.unavailable!=={}){unavailable=result.unavailable;animes=JSON.parse(xmlHttp.responseText).data;animes.sort((co1,co2)=>co1.series.name.localeCompare(co2.series.name));chrome.storage.local.set({"animes":animes});for(a in unavailable){var unavailableAnime=unavailable[a];for(b in animes){var anime=animes[b];if(anime.series.series_id===unavailableAnime.series.series_id){if(anime.most_likely_media.media_id===unavailableAnime.most_likely_media.media_id){if(!(anime.most_likely_media.playhead>=unavailableAnime.most_likely_media.duration-10)){if(!anime.most_likely_media.premium_only&&unavailableAnime.most_likely_media.premium_only){available.push(anime);unavailable.splice(a,1);break}}}else{available.push(anime);unavailable.splice(a,1);break}}}}
for(i in available){var anime=available[i];chrome.notifications.create({type:"image",iconUrl:"assets/icons/crunchysync.png",imageUrl:anime.most_likely_media.screenshot_image.fwide_url,title:"A new Episode of "+anime.series.name+" is available",message:anime.most_likely_media.name+"\nEpisode Nr."+anime.most_likely_media.episode_number})}}
chrome.storage.local.get(["userIsPremium"],function(result){unavailable=animes.filter(anime=>anime.most_likely_media.playhead>=anime.most_likely_media.duration-10);if(result.userIsPremium!==undefined&&(result.userIsPremium==="false")){unavailable=unavailable.concat(animes.filter(anime=>anime.most_likely_media.premium_only))}
chrome.storage.local.set({"unavailable":unavailable})})}else{chrome.notifications.create({type:"basic",iconUrl:"assets/icons/crunchysync.png",title:"Crunchysync's backgroundsync encountered an error",message:JSON.parse(xmlHttp.responseText).code})}}}
xmlHttp.open("GET",apiurl,!0);xmlHttp.send(null)}})})}
