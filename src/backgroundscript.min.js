var createdtab=void 0,animes=[],unavailable=[],available=[],userIsPremium=!1;function checkUnavailableAnimes(){chrome.storage.local.get(["unavailable","userIsPremium"],function(e){void 0!==e.userIsPremium&&(userIsPremium="true"===e.userIsPremium),chrome.cookies.get({url:"http://crunchyroll.com",name:"sess_id"},function(s){if(null!=s){var n="https://api.crunchyroll.com/queue.0.json?&fields=most_likely_media,series,series.name,series.media_count,series.series_id,media.description,media.media_id,media.free_available_time,media.name,media.url,media.episode_number,series.url,media.screenshot_image,media.duration,media.playhead,media.premium_only,image.fwide_url&media_types=anime|drama&locale=en&session_id="+s.value,r=new XMLHttpRequest;r.onreadystatechange=function(){if(4==r.readyState&&200==r.status)if(JSON.parse(r.responseText).error)chrome.notifications.create({type:"basic",iconUrl:"assets/icons/crunchysync.png",title:"Crunchysync's backgroundsync encountered an error",message:JSON.parse(r.responseText).code});else{if(chrome.alarms.create("checkUnavailableAnimes",{delayInMinutes:30}),void 0!==e.unavailable||e.unavailable!=={}){for(a in unavailable=e.unavailable,(animes=JSON.parse(r.responseText).data).sort((e,a)=>e.series.name.localeCompare(a.series.name)),chrome.storage.local.set({animes:animes}),unavailable){var s=unavailable[a];for(b in animes){if(void 0!==(n=animes[b]).most_likely_media&&n.series.series_id===s.series.series_id){if(n.most_likely_media.media_id!==s.most_likely_media.media_id){available.push(n),unavailable.splice(a,1);break}if(!(n.most_likely_media.playhead>=s.most_likely_media.duration-10)&&!n.most_likely_media.premium_only&&s.most_likely_media.premium_only){available.push(n),unavailable.splice(a,1);break}}}}for(i in available){var n=available[i];chrome.notifications.create({type:"image",iconUrl:"assets/icons/crunchysync.png",imageUrl:n.most_likely_media.screenshot_image.fwide_url,title:"A new Episode of "+n.series.name+" is available",message:n.most_likely_media.name+"\nEpisode Nr."+n.most_likely_media.episode_number})}}animes=animes.filter(e=>void 0!==e.most_likely_media),unavailable=animes.filter(e=>e.most_likely_media.playhead>=e.most_likely_media.duration-10),0==userIsPremium&&(unavailable=unavailable.concat(animes.filter(e=>e.most_likely_media.premium_only))),chrome.storage.local.set({unavailable:unavailable})}},r.open("GET",n,!0),r.send(null)}})})}chrome.runtime.onStartup.addListener(function(){chrome.storage.local.get(["disableBackgroundChecks","firstuse"],function(e){void 0!==e.disableBackgroundChecks&&"false"===e.disableBackgroundChecks&&void 0!==e.firstuse&&"false"===e.firstuse&&chrome.cookies.get({url:"http://crunchyroll.com",name:"sess_id"},function(e){null==e?chrome.tabs.create({url:"index.html"},function(e){createdtab=e}):checkUnavailableAnimes()})})}),chrome.runtime.onInstalled.addListener(function(e){chrome.storage.local.get(["disableBackgroundChecks","firstuse"],function(e){void 0!==e.disableBackgroundChecks&&"false"===e.disableBackgroundChecks&&void 0!==e.firstuse&&"false"===e.firstuse&&chrome.cookies.get({url:"http://crunchyroll.com",name:"sess_id"},function(e){null==e?chrome.tabs.create({url:"index.html"},function(e){createdtab=e}):checkUnavailableAnimes()})})}),chrome.alarms.onAlarm.addListener(function(e){"checkUnavailableAnimes"===e.name&&checkUnavailableAnimes()}),chrome.runtime.onMessage.addListener(function(e,a,i){if("onAuthenticatedEvent"==e.data&&chrome.tabs.query({url:"chrome-extension://*/index.html"},function(e){if(void 0!==createdtab)for(var a in checkUnavailableAnimes(),e){if(e[a].id===createdtab.id){chrome.tabs.remove(createdtab.id),createdtab=void 0;break}}}),"getSessionId"==e.data)return chrome.cookies.get({url:"http://crunchyroll.com",name:"sess_id"},function(e){i({sessionid:e})}),!0;"injectContentScriptCss"==e.data&&chrome.tabs.query({url:"*://*.crunchyroll.com/home/queue*"},function(e){chrome.tabs.insertCSS(e[0].id,{file:"queuescript.min.css"})})});