var createdtab=void 0,animes=[],unavailable=[],available=[];function checkUnavailableAnimes(){chrome.storage.local.get(["unavailable"],function(e){void 0!==e.unavailable&&chrome.cookies.get({url:"http://crunchyroll.com",name:"sess_id"},function(s){var n="https://api.crunchyroll.com/queue.0.json?&fields=most_likely_media,series,series.name,series.media_count,series.series_id,media.description,media.media_id,media.free_available_time,media.name,media.url,media.episode_number,series.url,media.screenshot_image,media.duration,media.playhead,media.premium_only,image.fwide_url&media_types=anime|drama&locale=enUS&session_id="+s.value,r=new XMLHttpRequest;r.onreadystatechange=function(){if(4==r.readyState&&200==r.status)if(JSON.parse(r.responseText).error)chrome.notifications.create({type:"basic",iconUrl:"assets/icons/premium.png",title:"Crunchysync's backgroundsync encountered an error",message:JSON.parse(r.responseText).code});else{unavailable=e.unavailable,(animes=JSON.parse(r.responseText).data).sort((co1, co2) => co1.series.name.localeCompare(co2.series.name)),chrome.storage.local.set({animes:animes});for(a in unavailable){var s=unavailable[a];for(b in animes){if((n=animes[b]).series.series_id===s.series.series_id){if(n.most_likely_media.media_id!==s.most_likely_media.media_id){available.push(n),unavailable.splice(a,1);break}if(!(n.most_likely_media.playhead>=n.most_likely_media.duration-10)&&!n.most_likely_media.premium_only&&s.most_likely_media.premium_only){available.push(n),unavailable.splice(a,1);break}}}}for(i in available){var n=available[i];chrome.notifications.create({type:"image",iconUrl:"assets/icons/premium.png",imageUrl:n.most_likely_media.screenshot_image.fwide_url,title:"A new Episode of "+n.series.name+" is available",message:n.most_likely_media.name+"\nEpisode Nr."+n.most_likely_media.episode_number})}chrome.storage.local.get(["userIsPremium"],function(e){unavailable=animes.filter(anime => anime.most_likely_media.playhead >= anime.most_likely_media.duration - 10),void 0!==e.userIsPremium&&"false"===e.userIsPremium&&(unavailable=unavailable.concat(animes.filter(anime => anime.most_likely_media.premium_only))),chrome.storage.local.set({unavailable:unavailable})}),chrome.alarms.create("checkUnavailableAnimes",{delayInMinutes:30})}},r.open("GET",n,!0),r.send(null)})})}chrome.runtime.onStartup.addListener(function(){chrome.storage.local.get(["disableBackgroundChecks","firstuse"],function(e){void 0!==e.disableBackgroundChecks&&"false"===e.disableBackgroundChecks&&void 0!==e.firstuse&&"false"===e.firstuse&&chrome.tabs.create({url:"index.html"},function(e){createdtab=e})})}),chrome.runtime.onInstalled.addListener(function(e){chrome.storage.local.get(["disableBackgroundChecks","firstuse"],function(e){void 0!==e.disableBackgroundChecks&&"false"===e.disableBackgroundChecks&&void 0!==e.firstuse&&"false"===e.firstuse&&chrome.tabs.create({url:"index.html"},function(e){createdtab=e})})}),chrome.alarms.onAlarm.addListener(function(e){"checkUnavailableAnimes"===e.name&&checkUnavailableAnimes()}),chrome.runtime.onMessage.addListener(function(e,a,i){if("onAuthenticatedEvent"==e.data&&chrome.tabs.query({url:"chrome-extension://*/index.html"},function(e){if(void 0!==createdtab){checkUnavailableAnimes();for(var a in e){if(e[a].id===createdtab.id){chrome.tabs.remove(createdtab.id),createdtab=void 0;break}}}}),"getSessionId"==e.data)return chrome.cookies.get({url:"http://crunchyroll.com",name:"sess_id"},function(e){i({sessionid:e})}),!0;"injectContentScriptCss"==e.data&&chrome.tabs.query({url:"*://*.crunchyroll.com/home/queue*"},function(e){chrome.tabs.insertCSS(e[0].id,{file:"queuescript.min.css"})})});
